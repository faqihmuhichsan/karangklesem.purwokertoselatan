<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Desa Karangklesem</title>
    <link rel="icon" href="../../images/Lambang Banyumas Asli.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">
    <link rel="stylesheet" href="css/leaflet-search.css">

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        
        /* HEADER Pastikan Z-Index Paling Tinggi */
        header { z-index: 5000; position: relative; }
        
        /* MAP FULL HEIGHT */
        #map { width: 100%; height: calc(100vh - 64px); position: relative; z-index: 1; background: #f8fafc; }
        
        .nav-link { position: relative; overflow: hidden; }
        .nav-link::before {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background-color: #fde047; transform: scaleX(0); transform-origin: right;
            transition: transform 0.3s ease;
        }
        .nav-link:hover::before { transform: scaleX(1); transform-origin: left; }

        .custom-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #312e81; border-radius: 4px;
            padding: 1px 5px; font-size: 10px; font-weight: 700; color: #1e1b4b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .label-nama-desa-utama {
            background: transparent !important; 
            border: none !important; 
            box-shadow: none !important;
            color: #be123c !important; 
            font-size: 16px !important; 
            font-weight: 900 !important;
            text-transform: uppercase; 
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; 
            white-space: nowrap; letter-spacing: 1px; pointer-events: none;
        }
        
        .custom-div-icon i { filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.4)); transition: transform 0.2s; }
        .custom-div-icon:hover i { transform: scale(1.5) translateY(-5px); color: #fbbf24 !important; cursor: pointer; }
        .leaflet-control-measure-toggle { background-image: none !important; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-indigo-900/95 backdrop-blur-md text-white shadow-lg sticky top-0 z-[5000]">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                
                <div class="flex items-center space-x-3 group cursor-pointer" onclick="window.location.href='../../index.html'">
                    <img src="../../images/Lambang Banyumas Asli.png" alt="Logo" class="relative w-10 h-10 rounded-full bg-white p-1 transition-transform group-hover:rotate-12">
                    <div>
                        <span class="font-bold hidden sm:block text-base">Purwokerto Selatan</span>
                    </div>
                </div>
                
                <div class="hidden md:flex space-x-2 items-center">
                    <a href="../../index.html" class="nav-link px-3 py-2 text-sm font-medium rounded-md hover:bg-white/5 transition">Beranda</a>
                    <a href="../../purwokerto selatan/index.html" class="nav-link px-3 py-2 text-sm font-medium rounded-md hover:bg-white/5 transition">Peta Kecamatan</a>
                    <div class="relative group" tabindex="0">
                        <button class="nav-link px-4 py-2 text-sm font-medium rounded-md hover:bg-white/5 transition flex items-center">
                            Peta Desa <i class="fas fa-chevron-down ml-2 text-[10px]"></i>
                        </button>
                        <div class="absolute left-0 top-full mt-0 w-48 bg-white text-slate-800 rounded-lg shadow-xl opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transform scale-95 group-hover:scale-100 transition-all duration-200 border border-slate-100 overflow-hidden">
                            <a href="../berkoh/berkoh.html" class="block px-4 py-2 text-sm hover:bg-indigo-50 border-b border-slate-100 transition-colors"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Berkoh</a>
                            <a href="karangklesem.html" class="block px-4 py-2 text-sm bg-indigo-50 font-bold border-b border-gray-100 text-indigo-700"><i class="fas fa-map-marker-alt text-indigo-700 mr-2"></i>Karangklesem</a>
                            <a href="../karangpucung/karangpucung.html" class="block px-4 py-2 text-sm hover:bg-indigo-50 border-b border-slate-100 transition-colors"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Karangpucung</a>
                            <a href="../teluk/teluk.html" class="block px-4 py-2 text-sm hover:bg-indigo-50 transition-colors"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Teluk</a>
                        </div>
                    </div>
                    <a href="../../index.html#about" class="nav-link px-3 py-2 text-sm font-medium rounded-md hover:bg-white/5 transition">Tentang</a>
                </div>

                <button type="button" onclick="toggleMenu()" class="md:hidden p-2 rounded-md text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white transition-colors" aria-label="Menu">
                    <i id="menu-icon" class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="hidden md:hidden absolute top-16 left-0 w-full bg-indigo-900 border-t border-indigo-800 shadow-2xl z-[5001] max-h-[80vh] overflow-y-auto">
            <div class="p-4 space-y-2">
                <a href="../../index.html" class="block px-3 py-3 rounded-md hover:bg-indigo-800 text-sm font-medium transition-colors border-b border-indigo-800">Beranda</a>
                <a href="../../purwokerto selatan/index.html" class="block px-3 py-3 rounded-md hover:bg-indigo-800 text-sm font-medium transition-colors border-b border-indigo-800">Peta Kecamatan</a>
                
                <div class="mt-2 pt-2">
                    <p class="px-3 text-xs font-bold text-yellow-400 uppercase mb-2">Pilih Peta Desa:</p>
                    <a href="../berkoh/berkoh.html" class="block px-3 py-2 rounded-md hover:bg-indigo-800 text-sm pl-6 transition-colors"><i class="fas fa-map-marker-alt mr-2 text-indigo-300"></i>Berkoh</a>
                    <a href="karangklesem.html" class="block px-3 py-2 rounded-md bg-indigo-800 text-sm pl-6 font-bold border-l-4 border-yellow-400"><i class="fas fa-map-marker-alt mr-2 text-yellow-400"></i>Karangklesem</a>
                    <a href="../karangpucung/karangpucung.html" class="block px-3 py-2 rounded-md hover:bg-indigo-800 text-sm pl-6 transition-colors"><i class="fas fa-map-marker-alt mr-2 text-indigo-300"></i>Karangpucung</a>
                    <a href="../teluk/teluk.html" class="block px-3 py-2 rounded-md hover:bg-indigo-800 text-sm pl-6 transition-colors"><i class="fas fa-map-marker-alt mr-2 text-indigo-300"></i>Teluk</a>
                </div>
                
                <div class="mt-2 pt-2 border-t border-indigo-800">
                    <a href="../../index.html#about" class="block px-3 py-3 rounded-md hover:bg-indigo-800 text-sm font-medium transition-colors">Tentang</a>
                </div>
            </div>
        </div>
    </header>

    <main><div id="map"></div></main>
    
    <div id="map-title-popup" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white border-l-4 border-indigo-900 text-slate-800 rounded px-3 py-2 shadow-md z-50">
            <strong class="text-xs font-bold tracking-wide">DESA KARANGKLESEM</strong>
    </div>

    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="js/leaflet-search.js"></script>

    <script src="data/desapwt_4.js"></script> 
    <script src="data/WILAYAHKARANGKLESEMKU_6.js"></script>
    <script src="data/WILAYAHRW_7.js"></script>
    <script src="data/gang_8.js"></script>
    <script src="data/jalandesa_9.js"></script>
    <script src="data/jalannasional_10.js"></script>
    <script src="data/PointDsKarangklesem_11.js"></script>
    <script src="data/RUMAHSENDIRI_12.js"></script>
    <script src="data/Sesarehan_13.js"></script>
    <script src="data/BALAIDESA_14.js"></script>

    <script>
        // --- INISIALISASI PETA ---
        var map = L.map('map', { zoomControl: true, maxZoom: 22, minZoom: 3 });
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxNativeZoom: 19, maxZoom: 22 }).addTo(map);

        // --- FUNGSI TOGGLE MENU (PERBAIKAN UTAMA) ---
        // Fungsi ini dipanggil langsung dari onclick di HTML
        function toggleMenu() {
            const menu = document.getElementById('mobile-menu');
            const icon = document.getElementById('menu-icon');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times'); // Ubah jadi tanda silang
            } else {
                menu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars'); // Ubah jadi garis tiga
            }
        }

        // --- ICON HELPER ---
        function getIcon(name) {
            let iconClass = "fa-map-marker-alt", color = "#ef4444";
            const n = (name || "").toLowerCase();
            if (n.includes('balai desa')) { iconClass = "fa-landmark"; color = "#1e40af"; }
            else if (n.includes('masjid') || n.includes('mushola')) { iconClass = "fa-mosque"; color = "#15803d"; }
            else if (n.includes('sekolah') || n.includes('sd')) { iconClass = "fa-graduation-cap"; color = "#a16207"; }
            else if (n.includes('toko') || n.includes('mart')) { iconClass = "fa-shopping-basket"; color = "#0d9488"; }
            else if (n.includes('rumah')) { iconClass = "fa-home"; color = "#7c3aed"; }
            return L.divIcon({
                html: `<i class="fas ${iconClass}" style="color: ${color}; font-size: 18px;"></i>`,
                className: 'custom-div-icon', iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10]
            });
        }

        // --- LAYER BATAS DESA (Highlight & Label) ---
        var layerBatasDesa = L.geoJson(json_WILAYAHKARANGKLESEMKU_6, { 
            style: { 
                color: '#e11d48', // Merah Rose
                weight: 4, dashArray: '', fillColor: '#f43f5e', fillOpacity: 0.05 
            },
            onEachFeature: function(feature, layer) {
                layer.bindTooltip("DESA KARANGKLESEM", { permanent: true, direction: 'center', className: 'label-nama-desa-utama' });
                layer.on({
                    mouseover: function(e) { 
                        e.target.setStyle({ weight: 5, color: '#fbbf24', fillOpacity: 0.2 }); 
                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { e.target.bringToFront(); }
                    },
                    mouseout: function(e) { layerBatasDesa.resetStyle(e.target); },
                    click: function(e) { map.fitBounds(e.target.getBounds()); }
                });
            }
        }).addTo(map);

        // --- LAYER JALAN (Highlight Style) ---
        function styleRoad(color, weight) { return { color: color, weight: weight, opacity: 0.8 }; }
        function highlightRoad(e) {
            e.target.setStyle({ color: '#06b6d4', weight: 6, opacity: 1 }); // Cyan Highlight
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { e.target.bringToFront(); }
        }
        function resetRoad(e, color, weight) { e.target.setStyle({ color: color, weight: weight, opacity: 0.8 }); }

        // Load 3 Tipe Jalan
        var jlnNasional = L.geoJson(json_jalannasional_10, { 
            style: styleRoad('#f97316', 5), // Orange Tebal
            onEachFeature: function(f, l) { l.on({ mouseover: highlightRoad, mouseout: (e) => resetRoad(e, '#f97316', 5) }); if(f.properties.name) l.bindPopup(f.properties.name); }
        });
        var jlnDesa = L.geoJson(json_jalandesa_9, { 
            style: styleRoad('#475569', 3), // Abu-abu Sedang
            onEachFeature: function(f, l) { l.on({ mouseover: highlightRoad, mouseout: (e) => resetRoad(e, '#475569', 3) }); if(f.properties.name) l.bindPopup(f.properties.name); }
        });
        var jlnGang = L.geoJson(json_gang_8, { 
            style: { color: '#94a3b8', weight: 1.5, dashArray: '3' }, // Putus-putus tipis
            onEachFeature: function(f, l) { l.on({ mouseover: highlightRoad, mouseout: (e) => e.target.setStyle({ color: '#94a3b8', weight: 1.5 }) }); if(f.properties.name) l.bindPopup(f.properties.name); }
        });

        // Gabungkan semua jalan ke satu Grup untuk Katalog
        var layerJalanGroup = L.layerGroup([jlnNasional, jlnDesa, jlnGang]);

        // --- LAYER FASILITAS & BANGUNAN ---
        var layerBuilding = L.geoJson(json_desapwt_4, { style: { color: '#abb2b9', weight: 0.5, fillColor: '#d5dbdb', fillOpacity: 0.7 } });
        var layerRW = L.geoJson(json_WILAYAHRW_7, { style: { color: '#22c55e', weight: 1.5, fillOpacity: 0.1 }, onEachFeature: (f,l) => { if(f.properties.NAMA) l.bindTooltip("RW "+f.properties.NAMA, {permanent:true, direction:'center', className:'custom-label'}) } });

        var layerFasumGroup = L.layerGroup();
        
        function processFeatures(data) {
            L.geoJson(data, {
                onEachFeature: (f, layer) => { 
                    const n = f.properties.NAMA || f.properties['Point Desa'] || "Lokasi"; 
                    layer.bindPopup(`<b>${n}</b>`); 
                    layer.bindTooltip(n, {permanent:true, direction:'top', offset:[0,-10], className:'custom-label'}); 
                },
                pointToLayer: (f, latlng) => L.marker(latlng, { icon: getIcon(f.properties.NAMA || "") })
            }).addTo(layerFasumGroup);
        }
        
        // Memuat semua data poin ke satu grup
        [json_BALAIDESA_14, json_Sesarehan_13, json_PointDsKarangklesem_11, json_RUMAHSENDIRI_12].forEach(processFeatures);

        // --- ZOOM VISIBILITY ---
        function updateVisibility() {
            var z = map.getZoom();
            if (z >= 15) { 
                if (!map.hasLayer(layerJalanGroup)) map.addLayer(layerJalanGroup);
                if (!map.hasLayer(layerFasumGroup)) map.addLayer(layerFasumGroup);
                if (!map.hasLayer(layerRW)) map.addLayer(layerRW);
                if (z >= 17 && !map.hasLayer(layerBuilding)) map.addLayer(layerBuilding);
            } else { 
                if (map.hasLayer(layerJalanGroup)) map.removeLayer(layerJalanGroup);
                if (map.hasLayer(layerFasumGroup)) map.removeLayer(layerFasumGroup);
                if (map.hasLayer(layerRW)) map.removeLayer(layerRW);
                if (map.hasLayer(layerBuilding)) map.removeLayer(layerBuilding);
            }
        }
        map.on('zoomend', updateVisibility);
        updateVisibility();

        function centerMap() { map.fitBounds(layerBatasDesa.getBounds(), { padding: [50, 50] }); }
        window.onload = centerMap;

        // --- KATALOG LAYER (SESUAI REQUEST) ---
        var overlaysTree = { 
            label: '<b>Katalog Desa Karangklesem</b>', 
            selectAllCheckbox: true,
            children: [ 
                {label: 'üö© Batas Desa (Aktif)', layer: layerBatasDesa},
                {label: 'üõ£Ô∏è Jalan Desa', layer: layerJalanGroup},
                {label: 'üèõÔ∏è Fasilitas & Balai Desa', layer: layerFasumGroup},
                {label: 'üè¢ Batas RW', layer: layerRW},
                {label: 'üè† Bangunan Warga', layer: layerBuilding}
            ] 
        };
        L.control.layers.tree(null, overlaysTree, { collapsed: false }).addTo(map);

        map.addControl(new L.Control.Search({ layer: layerFasumGroup, propertyName: 'NAMA', initial: false, hideMarkerOnCollapse: true }));
        var measureControl = new L.Control.Measure({ position: 'topleft', primaryLengthUnit: 'meters' });
        measureControl.addTo(map);
        document.querySelector('.leaflet-control-measure-toggle').innerHTML = '<i class="fas fa-ruler"></i>';

    </script>
</body>
</html>