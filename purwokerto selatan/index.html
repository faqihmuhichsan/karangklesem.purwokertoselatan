<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Peta Purwokerto Selatan</title>
    <link rel="icon" href="../images/Lambang Banyumas Asli.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; height: 100vh; margin: 0; overflow: hidden; background: #f0f0f0; }
        
        /* HEADER (Fixed Top) */
        header { position: fixed; top: 0; left: 0; right: 0; height: 64px; z-index: 2000; }

        /* MAP CONTAINER (Full Screen dikurangi Header) */
        #map { 
            position: absolute; 
            top: 64px; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            width: 100%; 
            height: calc(100vh - 64px); 
            z-index: 1; 
        }
        
        /* Label Nama Desa */
        .label-desa {
            background: transparent;
            border: none;
            color: #ffffff; 
            font-weight: 900; 
            font-size: 13pt; 
            text-transform: uppercase;
            white-space: nowrap;
            text-shadow: 
                -1.5px -1.5px 0 #000,  
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000,
                 3px 3px 5px rgba(0,0,0,0.8); 
            letter-spacing: 1px;
            pointer-events: none; 
        }

        /* Label Tooltip untuk Balai Desa */
        .label-balai {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #1e40af;
            color: #1e40af;
            font-weight: bold;
            font-size: 9pt;
            padding: 2px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .nav-link { position: relative; }
        .nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: #fde047; transform: scaleX(0); transition: 0.3s;
        }
        .nav-link:hover::after { transform: scaleX(1); }

        .leaflet-control-measure-toggle {
            background-image: none !important; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50">
    
    <header id="main-header" class="bg-indigo-900 text-white shadow-lg">
        <nav class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <a href="../index.html" target="_top" class="flex items-center gap-3">
                    <img src="../images/Lambang Banyumas Asli.png" alt="Logo" class="w-10 h-10 bg-white rounded-full p-1">
                    <span class="font-bold hidden sm:inline">Purwokerto Selatan</span>
                </a>
            </div>
            
            <div class="hidden md:flex items-center space-x-6">
                <a href="../index.html" target="_top" class="nav-link text-sm font-medium">Beranda</a>
                <div class="relative group">
                    <button class="nav-link text-sm font-medium flex items-center gap-1">
                        Peta Desa <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="absolute right-0 top-full w-48 bg-white text-slate-800 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border border-slate-100">
                        <a href="../desa/berkoh/berkoh.html" class="block px-4 py-2 hover:bg-indigo-50 border-b border-gray-100"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Berkoh</a>
                        <a href="../desa/karangklesem/karangklesem.html" class="block px-4 py-2 hover:bg-indigo-50 border-b border-gray-100"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Karangklesem</a>
                        <a href="../desa/karangpucung/karangpucung.html" class="block px-4 py-2 hover:bg-indigo-50 border-b border-gray-100"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Karangpucung</a>
                        <a href="../desa/teluk/teluk.html" class="block px-4 py-2 hover:bg-indigo-50"><i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>Teluk</a>
                    </div>
                </div>
                <a href="../index.html#about" target="_top" class="nav-link text-sm font-medium">Tentang</a>
            </div>

            <button id="mobile-menu-btn" class="md:hidden p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </nav>

        <div id="mobile-menu" class="hidden absolute top-16 left-0 w-full bg-indigo-900 border-t border-indigo-800 p-4 space-y-3 shadow-xl md:hidden">
            <a href="../index.html" target="_top" class="block text-sm hover:bg-indigo-800 p-2 rounded">Beranda</a>
            <a href="../desa/berkoh/berkoh.html" class="block text-sm hover:bg-indigo-800 p-2 rounded"><i class="fas fa-map-marker-alt mr-2 text-yellow-400"></i>Berkoh</a>
            <a href="../desa/karangklesem/karangklesem.html" class="block text-sm hover:bg-indigo-800 p-2 rounded"><i class="fas fa-map-marker-alt mr-2 text-yellow-400"></i>Karangklesem</a>
            <a href="../desa/karangpucung/karangpucung.html" class="block text-sm hover:bg-indigo-800 p-2 rounded"><i class="fas fa-map-marker-alt mr-2 text-yellow-400"></i>Karangpucung</a>
            <a href="../desa/teluk/teluk.html" class="block text-sm hover:bg-indigo-800 p-2 rounded"><i class="fas fa-map-marker-alt mr-2 text-yellow-400"></i>Teluk</a>
            <a href="../index.html#about" target="_top" class="block text-sm hover:bg-indigo-800 p-2 rounded">Tentang</a>
        </div>
    </header>

    <div id="map"></div>

    <div id="map-title-popup" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white border-l-4 border-indigo-900 text-slate-800 rounded px-3 py-2 shadow-md z-[1500]">
        <strong class="text-xs font-bold tracking-wide">KECAMATAN PURWOKERTO SELATAN</strong>
    </div>

    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet-measure.js"></script>
    
    <script src="data/BATASWILAYAH_1.js"></script>
    <script src="data/WILAYAHPURWOKERTOSELATAN_2.js"></script>
    <script src="data/BALAIDESA_3.js"></script>
    <script src="data/JALAN_4.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DETEKSI IFRAME
            if (window.self !== window.top) {
                const header = document.getElementById('main-header');
                if (header) header.style.display = 'none';

                const mapDiv = document.getElementById('map');
                if (mapDiv) {
                    mapDiv.style.top = '0';
                    mapDiv.style.height = '100vh';
                }
            }
        });

        // 1. INISIALISASI PETA DENGAN KOORDINAT DEFAULT
        // PERBAIKAN: set zoomControl ke false untuk menghilangkan tombol default (yang bikin dobel)
        var map = L.map('map', { 
            zoomControl: false, 
            maxZoom: 18, 
            minZoom: 5, 
            attributionControl: false 
        }).setView([-7.4407, 109.2439], 13); 

        // Tambahkan Zoom Control Manual (Agar posisinya sesuai keinginan dan cuma satu)
        L.control.zoom({ position: 'topleft' }).addTo(map);

        map.createPane('pane_GoogleMaps_0');
        map.getPane('pane_GoogleMaps_0').style.zIndex = 400;
        var layer_GoogleMaps_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMaps_0', opacity: 1.0
        }).addTo(map);

        // --- ICON HELPER ---
        function getIcon(name) {
            let iconClass = "fa-map-marker-alt", color = "#ef4444";
            const n = (name || "").toLowerCase();

            if (n.includes('balai desa') || n.includes('kantor') || n.includes('kelurahan')) { 
                iconClass = "fa-landmark"; color = "#1e40af"; 
            } else if (n.includes('masjid') || n.includes('mushola')) { 
                iconClass = "fa-mosque"; color = "#15803d"; 
            } else if (n.includes('sekolah') || n.includes('sd') || n.includes('tk')) {
                iconClass = "fa-graduation-cap"; color = "#a16207"; 
            } else if (n.includes('klinik') || n.includes('posyandu')) {
                iconClass = "fa-heart-pulse"; color = "#be123c"; 
            } else if (n.includes('toko') || n.includes('mart')) {
                iconClass = "fa-shopping-basket"; color = "#0d9488"; 
            } else if (n.includes('faqih') || n.includes('rumah')) { 
                iconClass = "fa-home"; color = "#7c3aed"; 
            }

            return L.divIcon({
                html: `<i class="fas ${iconClass}" style="color: ${color}; font-size: 18px;"></i>`,
                className: 'custom-div-icon', iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10]
            });
        }

        // --- STYLING WILAYAH ---
        function style_Wilayah(feature) {
            return {
                pane: 'pane_WILAYAHPURWOKERTOSELATAN_2',
                opacity: 0,          
                fillOpacity: 0,      
                color: 'transparent', 
                fill: true,
                interactive: true,   
            };
        }

        // --- LAYER NAMA DESA ---
        if (typeof json_WILAYAHPURWOKERTOSELATAN_2 !== 'undefined') {
            var layer_LabelDesa = new L.geoJson(json_WILAYAHPURWOKERTOSELATAN_2, {
                interactive: false, 
                pointToLayer: function(f, l) { return L.circleMarker(l, { radius: 0, opacity:0, fillOpacity:0 }); },
                onEachFeature: function(f, layer) {
                    layer.bindTooltip(f.properties['NAME_4'], {
                        permanent: true, direction: 'center', className: 'label-desa', interactive: false
                    });
                }
            }).addTo(map);

            // --- LAYER WILAYAH (POLYGON) ---
            map.createPane('pane_WILAYAHPURWOKERTOSELATAN_2');
            map.getPane('pane_WILAYAHPURWOKERTOSELATAN_2').style.zIndex = 401;
            var layer_WILAYAHPURWOKERTOSELATAN_2 = new L.geoJson(json_WILAYAHPURWOKERTOSELATAN_2, {
                pane: 'pane_WILAYAHPURWOKERTOSELATAN_2',
                style: style_Wilayah,
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: function(e) {
                            var l = e.target;
                            l.setStyle({ 
                                weight: 5,            
                                color: '#fbbf24',     
                                opacity: 1,           
                                fillColor: '#fbbf24',
                                fillOpacity: 0.2      
                            });
                            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                l.bringToFront();
                            }
                        },
                        mouseout: function(e) {
                            layer_WILAYAHPURWOKERTOSELATAN_2.resetStyle(e.target);
                        },
                        click: function(e) {
                            map.fitBounds(e.target.getBounds());
                            if(map.getZoom() > 16) map.setZoom(16);
                        }
                    });
                }
            }).addTo(map);
        }

        // --- LAYER JALAN ---
        var layer_JALAN_4;
        if (typeof json_JALAN_4 !== 'undefined') {
            map.createPane('pane_JALAN_4');
            map.getPane('pane_JALAN_4').style.zIndex = 402;
            layer_JALAN_4 = new L.geoJson(json_JALAN_4, {
                pane: 'pane_JALAN_4',
                style: { color: '#ef4444', weight: 2, opacity: 0.7 },
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: function(e) {
                            var l = e.target;
                            l.setStyle({ color: '#06b6d4', weight: 6, opacity: 1 });
                            l.bringToFront();
                        },
                        mouseout: function(e) {
                            var l = e.target;
                            l.setStyle({ color: '#ef4444', weight: 2, opacity: 0.7 });
                        },
                        click: function(e) {
                            if (feature.properties['name']) {
                                layer.bindPopup("<b>" + feature.properties['name'] + "</b>").openPopup();
                            }
                        }
                    });
                }
            });
        }

        // --- LAYER BALAI DESA ---
        var layer_BALAIDESA_3;
        if (typeof json_BALAIDESA_3 !== 'undefined') {
            map.createPane('pane_BALAIDESA_3');
            map.getPane('pane_BALAIDESA_3').style.zIndex = 405; 
            
            var iconBalai = L.divIcon({
                html: '<i class="fas fa-landmark" style="color: #1e40af; font-size: 18px; filter: drop-shadow(2px 2px 2px rgba(255,255,255,0.8));"></i>',
                className: 'custom-div-icon', iconSize: [20, 20], iconAnchor: [10, 10]
            });

            layer_BALAIDESA_3 = new L.geoJson(json_BALAIDESA_3, {
                pane: 'pane_BALAIDESA_3',
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, { icon: iconBalai });
                },
                onEachFeature: function (feature, layer) {
                    if (feature.properties['NAMA']) {
                        layer.bindTooltip(feature.properties['NAMA'], {
                            permanent: true, 
                            direction: 'top', 
                            offset: [0, -15],
                            className: 'label-balai'
                        });
                    }
                }
            });
        }

        // --- ZOOM KE WILAYAH (Jika data ada) ---
        setTimeout(function() {
            if (typeof layer_WILAYAHPURWOKERTOSELATAN_2 !== 'undefined') {
                var bounds = layer_WILAYAHPURWOKERTOSELATAN_2.getBounds();
                if(bounds.isValid()){
                    map.fitBounds(bounds, { padding: [30, 30] });
                }
            }
        }, 500);

        document.getElementById('mobile-menu-btn').onclick = function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        };
        
        var measureControl = new L.Control.Measure({ position: 'topleft', primaryLengthUnit: 'meters' });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '<i class="fas fa-ruler"></i>';

        // --- KATALOG LAYER ---
        var overlaysTree = { 
            label: '<b>Katalog Purwokerto Selatan</b>', 
            selectAllCheckbox: true,
            children: [] 
        };

        if (typeof layer_WILAYAHPURWOKERTOSELATAN_2 !== 'undefined') {
            overlaysTree.children.push({label: 'üö© Batas Wilayah (Aktif)', layer: layer_WILAYAHPURWOKERTOSELATAN_2});
        }
        if (typeof layer_JALAN_4 !== 'undefined') {
            overlaysTree.children.push({label: 'üõ£Ô∏è Jalan Kecamatan', layer: layer_JALAN_4});
        }
        if (typeof layer_BALAIDESA_3 !== 'undefined') {
            overlaysTree.children.push({label: 'üèõÔ∏è Balai Desa', layer: layer_BALAIDESA_3});
        }

        L.control.layers.tree(null, overlaysTree, { collapsed: false }).addTo(map);

    </script>
</body>
</html>